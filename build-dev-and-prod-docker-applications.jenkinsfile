#!groovy
pipeline {
    agent {
        node {
            label 'build-server'
        }
    }
    stages {
        stage('Start'){
            steps{
                dir('files'){
                    println 'Ensuring workspace is empty'
                    deleteDir()
                }
            }
        }
        stage('Clone repository from GitHub'){
            steps{
                dir('files') {
                    println 'Cloning GitHub repository'
                    script {
                        pwsh 'git clone $env:GithubRepo -b $env:GithubBranch'
                    }
                }
            }
        }
        stage('Check blue/green deployment status'){
            steps{
                env.DevDockerContainerTagBlueGreen = pwsh(returnStdout: true, script: '''
                    if (Test-Path $env:BlueNginxConfigLocation) {
                        Write-Output "$env:DevDockerContainerTag-green"
                    } elseif (Test-Path $env:GreenNginxConfigLocation) {
                        Write-Output "$env:DevDockerContainerTag-blue"
                    } else {
                        Write-Output $env:DevDockerContainerTag
                    }
                '''}
                println "env.DevDockerContainerTagBlueGreen:"
                println env.DevDockerContainerTagBlueGreen
            }
        }
        stage('Build dev and prod dockerfiles'){
            steps{
                dir('files' + ProjectDirectory){
                    println 'Building dockerfile'
                    pwsh '''
                        sudo docker build -f $env:DevDockerfileLocation -t $env:DevDockerContainerTagBlueGreen .
                        if ($env:NewRelicLicenseKey.length -ne 0) {
                            sudo docker build -f $env:ProdDockerfileLocation --build-arg new_relic_license_key=$env:NewRelicLicenseKey -t $env:ProdDockerContainerTag .
                        } else {
                            sudo docker build -f $env:ProdDockerfileLocation -t $env:ProdDockerContainerTag .
                        }
                    '''
                }
            }
        }
        stage ('Push dev and prod docker containers'){
            steps{
                dir('files'){
                    println 'Pushing docker container'
                    pwsh '''
                        sudo docker push $env:DevDockerContainerTagBlueGreen
                        sudo docker push $env:ProdDockerContainerTag
                    '''
                }
            }
        }
        stage('Clean up'){
            steps{
                dir('files'){
                    println 'Removing cloned GitHub repository'
                    deleteDir()
                }
            }
        }
    }
}